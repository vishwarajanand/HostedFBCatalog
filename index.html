<!DOCTYPE html>

<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
</head>
<html>

<body>
    <div id="dpa_content" hidden>
        <h1 id="product_title"></h1>
        <p id="product_id"></p>
        <p id="product_price"></p>
        <p id="utm_source"></p>
        <img id="product_img" src="" alt="Product Image" height="400" width="400">
    </div>
    <div id="readme_content" hidden>
        <h1>Contains some CSV files to be used for Facebook Dynamic Ads testing.</h1>

        <p>Facebook Dynamic Ads need catalog file which can be passed as a feed so that backend learns of all the
            products available on the website inventory.</p>
        <p>This repository contains a page hosted here: <a
                href="https://vishwarajanand.github.io/HostedSampleFBCatalogs/">https://vishwarajanand.github.io/HostedSampleFBCatalogs/</a>.
        </p>
    </div>

    <script>
        var got_product_details = false; // mark true when all details correctly fetched
        function resetView() {
            if (got_product_details) {
                // show dpa landing website
                document.getElementById("dpa_content").hidden = false;
                document.getElementById("readme_content").hidden = true;
            } else {
                // dont show any dpa website
                document.getElementById("dpa_content").hidden = true;
                document.getElementById("readme_content").hidden = false;
            }
        }
        var currentURL = new URL(window.location.href);
        var item_id = currentURL.searchParams.get("item_id");
        if (item_id !== null) {
            var catalogURL = window.location.origin + window.location.pathname + "dpa_product_catalog_sample_feed.csv";
            $.ajax({
                type: "GET",
                url: catalogURL,
                dataType: "text",
                success: function (response) {
                    var allText = response;
                    // catalog fetched
                    var allTextLines = allText.split(/\r\n|\n/);
                    var entries = allTextLines[0].split(',');
                    // index of id is 0
                    for (var allTextLine of allTextLines) {
                        var fields = allTextLine.split(',');
                        if (fields[0] === item_id) {
                            // found a match in item id
                            document.getElementById("product_id").innerHTML = "Product ID: " + fields[entries.indexOf("id")];
                            document.getElementById("product_title").innerHTML = "Product Title: " + fields[entries.indexOf("title")];
                            document.getElementById("product_price").innerHTML = "Product Price: " + fields[entries.indexOf("price")];
                            document.getElementById("product_img").src = fields[entries.indexOf("image[0].url")];

                            // mark product details fetched successfully
                            got_product_details = true;
                            resetView();
                        }
                    }
                },
                error: function (error) {
                    // error while fetching URL
                    got_product_details = false;
                    resetView();
                    console.log("Could not read get '" + item_id + "' from '" + catalogURL + "', please check the URL or contact admin.");
                }
            });

            // check if utm_source is present, add it 
            var utm_source = currentURL.searchParams.get("utm_source");
            if (utm_source !== null) {
                document.getElementById("utm_source").innerHTML = utm_source;
            }

            //reset view
            resetView();
        }
    </script>

</body>

</html>